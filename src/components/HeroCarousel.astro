---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

interface Props {
	images: {
		src: ImageMetadata;
		alt: string;
		fit?: 'cover' | 'contain';
	}[];
	interval?: number;
	id?: string;
}

const { images, interval = 5000, id } = Astro.props;
---

<div class="hero-carousel" data-interval={interval} data-carousel-id={id}>
	<div class="carousel-track">
		{images.map((image, index) => (
			<div class={`carousel-slide ${index === 0 ? 'active' : ''}`} data-index={index}>
				<Image 
					src={image.src} 
					alt={image.alt} 
					widths={[480, 768, 1024]}
					sizes="100vw"
					quality={60} 
					format="jpeg"
					loading={index === 0 ? 'eager' : 'lazy'}
					fetchpriority={index === 0 ? 'high' : 'low'}
					decoding={index === 0 ? 'sync' : 'async'}
					class={image.fit === 'contain' ? 'carousel-img contain' : 'carousel-img'}
				/>
			</div>
		))}
	</div>
	
	<div class="carousel-overlay"></div>
	
	<div class="carousel-indicators">
		{images.map((_, index) => (
			<button 
				class={`carousel-dot ${index === 0 ? 'active' : ''}`} 
				data-index={index}
				aria-label={`Slide ${index + 1}`}
			></button>
		))}
	</div>
</div>

<style>
	.hero-carousel {
		position: relative;
		width: 100%;
		height: 100vh;
		overflow: hidden;
	}

	.carousel-track {
		position: relative;
		width: 100%;
		height: 100%;
	}

	.carousel-slide {
		position: absolute;
		inset: 0;
		opacity: 0;
		transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1);
		will-change: opacity;
	}

	.carousel-slide.active {
		opacity: 1;
	}

	.carousel-img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		animation: kenburns 20s ease-in-out infinite alternate;
	}

	@keyframes kenburns {
		0% {
			transform: scale(1) translate(0, 0);
		}
		100% {
			transform: scale(1.08) translate(-1%, -1%);
		}
	}

	.carousel-img.contain {
		object-fit: contain;
		background: #000;
	}

	.carousel-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(
			to top,
			rgba(10, 10, 11, 0.95) 0%,
			rgba(10, 10, 11, 0.5) 40%,
			rgba(10, 10, 11, 0.2) 100%
		);
		pointer-events: none;
	}

	.carousel-indicators {
		position: absolute;
		bottom: 2rem;
		left: 50%;
		transform: translateX(-50%);
		display: flex;
		gap: 0.75rem;
		z-index: 10;
	}

	.carousel-dot {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		border: 2px solid rgba(255, 255, 255, 0.5);
		background: transparent;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.carousel-dot:hover,
	.carousel-dot.active {
		background: #d4a574;
		border-color: #d4a574;
	}

	.carousel-nav-group {
		position: absolute;
		left: clamp(2rem, 6vw, 6rem);
		bottom: clamp(2rem, 5vw, 4rem);
		display: flex;
		gap: 1rem;
		z-index: 30;
	}

	.carousel-nav {
		position: relative;
		background: rgba(0, 0, 0, 0.55);
		border: 1px solid rgba(255, 255, 255, 0.2);
		color: white;
		width: 52px;
		height: 52px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.3s ease;
		box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
	}

	.carousel-nav:hover {
		background: #d4a574;
		border-color: #d4a574;
		color: #0a0a0b;
		transform: translateY(-2px);
	}

	@media (max-width: 768px) {
		.carousel-nav-group {
			left: 50%;
			transform: translateX(-50%);
			bottom: 1.5rem;
		}

		.carousel-nav {
			width: 44px;
			height: 44px;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const carousels = document.querySelectorAll<HTMLDivElement>('.hero-carousel');
		
		carousels.forEach((carousel) => {
			const slides = carousel.querySelectorAll<HTMLDivElement>('.carousel-slide');
			const dots = carousel.querySelectorAll<HTMLButtonElement>('.carousel-dot');
			const carouselId = carousel.dataset.carouselId;
			
			const getExternalControl = (type: 'prev' | 'next') => {
				if (!carouselId) {
					return null;
				}
				return document.querySelector<HTMLButtonElement>(`[data-carousel-target="${carouselId}"][data-carousel-control="${type}"]`);
			};

			const prevBtn = getExternalControl('prev') ?? carousel.querySelector<HTMLButtonElement>('.carousel-prev');
			const nextBtn = getExternalControl('next') ?? carousel.querySelector<HTMLButtonElement>('.carousel-next');
			const interval = parseInt(carousel.dataset.interval ?? '5000', 10);
			
			let currentIndex = 0;
			let autoplayTimer: ReturnType<typeof setInterval> | null = null;

			const setActiveSlide = (index: number) => {
				slides.forEach((slide, i) => {
					slide.classList.toggle('active', i === index);
				});
				dots.forEach((dot, i) => {
					dot.classList.toggle('active', i === index);
				});
			};

			const goToSlide = (index: number) => {
				setActiveSlide(index);
				currentIndex = index;
			};

			const nextSlide = () => {
				const next = (currentIndex + 1) % slides.length;
				goToSlide(next);
			};

			const prevSlide = () => {
				const prev = (currentIndex - 1 + slides.length) % slides.length;
				goToSlide(prev);
			};

			const startAutoplay = () => {
				autoplayTimer = setInterval(nextSlide, interval);
			};

			const stopAutoplay = () => {
				if (autoplayTimer) {
					clearInterval(autoplayTimer);
					autoplayTimer = null;
				}
			};

			// Event listeners
			prevBtn?.addEventListener('click', () => {
				stopAutoplay();
				prevSlide();
				startAutoplay();
			});

			nextBtn?.addEventListener('click', () => {
				stopAutoplay();
				nextSlide();
				startAutoplay();
			});

			dots.forEach((dot, index) => {
				dot.addEventListener('click', () => {
					stopAutoplay();
					goToSlide(index);
					startAutoplay();
				});
			});

			// Pause on hover
			carousel.addEventListener('mouseenter', stopAutoplay);
			carousel.addEventListener('mouseleave', startAutoplay);

			// Touch support
			let touchStartX = 0;
			carousel.addEventListener('touchstart', (event) => {
				const e = event as TouchEvent;
				touchStartX = e.touches[0].clientX;
				stopAutoplay();
			}, { passive: true });

			carousel.addEventListener('touchend', (event) => {
				const e = event as TouchEvent;
				const touchEndX = e.changedTouches[0].clientX;
				const diff = touchStartX - touchEndX;
				
				if (Math.abs(diff) > 50) {
					if (diff > 0) {
						nextSlide();
					} else {
						prevSlide();
					}
				}
				startAutoplay();
			}, { passive: true });

			// Start autoplay and ensure first slide is active
			goToSlide(0);
			startAutoplay();
		});
	});
</script>
